<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chat học viên</title>
  <link rel="stylesheet" href="/app/app.css"/>
  <style>
    body {
      font-family: "Inter","Segoe UI",system-ui,sans-serif;
      background:#0a0e1c;
      color:#f8f4ff;
      margin:0;
      min-height:100vh;
    }
    .support-layout {
      display:grid;
      grid-template-columns:320px 1fr;
      gap:24px;
    }
    .support-panel {
      background:#151c33;
      border-radius:28px;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 20px 40px rgba(0,0,0,.45);
      display:flex;
      flex-direction:column;
      min-height:660px;
    }
    .support-panel h2 { margin:0; font-size:1.1rem; }
    .queue-filters {
      padding:24px;
      border-bottom:1px solid rgba(255,255,255,.05);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .queue-filters select,
    .queue-filters input {
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:#0f1530;
      padding:10px 16px;
      color:#f8f4ff;
    }
    .queue-filters input::placeholder { color:rgba(248,244,255,.7); }
    .queue-filters label { font-size:.85rem; color:#9ca3c7; display:flex; gap:6px; align-items:center; }
    .queue-filters button {
      border:none;
      border-radius:999px;
      padding:10px 16px;
      background:#8b5cf6;
      color:#fff;
      font-weight:600;
      cursor:pointer;
    }
    .thread-list {
      flex:1;
      overflow-y:auto;
    }
    .thread-item {
      width:100%;
      text-align:left;
      padding:14px 22px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color:#f8f4ff;
      background:transparent;
      transition:.2s;
    }
    .thread-item small { color:#aeb6d6; }
    .thread-item:hover,
    .thread-item.is-active {
      background:rgba(139,92,246,.15);
    }
    .chat-shell {
      background:#0f1530;
      border-radius:32px;
      border:1px solid rgba(255,255,255,.05);
      box-shadow:0 25px 55px rgba(0,0,0,.45);
      display:flex;
      flex-direction:column;
      min-height:660px;
      color:#f3f4ff;
    }
    .chat-header {
      padding:26px 32px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(135deg,#4c1d95,#7c3aed);
      color:#fff;
    }
    .chat-header h2 { margin:4px 0 8px; font-size:1.5rem; }
    .chat-header .subline { color:rgba(255,255,255,.7); font-size:.9rem; }
    .chat-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .chat-actions button {
      border:none;
      border-radius:999px;
      padding:10px 18px;
      font-weight:600;
      cursor:pointer;
      color:#fff;
      background:rgba(255,255,255,.15);
    }
    .chat-actions button:first-child { background:#f472b6; }
    .chat-actions button:nth-child(2) { background:#a855f7; }
    .chat-actions button:nth-child(3) { background:#fb7185; }
    .chat-actions button:last-child { background:#34d399; color:#0d1b3c; }
    .chat-messages {
      flex:1;
      overflow-y:auto;
      padding:24px 32px;
      display:flex;
      flex-direction:column;
      gap:16px;
      background:#0a1024;
    }
    .msg {
      max-width:75%;
      padding:14px 18px;
      border-radius:24px;
      box-shadow:0 10px 20px rgba(0,0,0,.35);
      line-height:1.45;
    }
    .msg-student { background:#1f2648; border:1px solid rgba(255,255,255,.08); color:#f5f6ff; }
    .msg-manager { background:#f472b6; color:#1e0f2f; margin-left:auto; border-bottom-right-radius:12px; }
    .msg-system { background:#191f3c; border:1px dashed rgba(255,255,255,.25); color:#a8b0d9; text-align:center; font-size:.82rem; margin:0 auto; }
    .msg-attachments img {
      max-width:220px;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.08);
      display:block;
      margin-top:10px;
    }
    .msg-attachments a {
      display:block;
      margin-top:10px;
      font-size:12px;
      text-decoration:underline;
      color:#c4774a;
    }
    .chat-form {
      padding:20px 32px 28px;
      border-top:1px solid rgba(255,255,255,.08);
      background:#0c122b;
    }
    .chat-form textarea {
      width:100%;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.15);
      padding:14px 18px;
      min-height:100px;
      resize:none;
      background:#060b20;
      color:#f8f9ff;
      font-family:inherit;
    }
    .chat-form button {
      margin-top:14px;
      border:none;
      border-radius:999px;
      padding:10px 30px;
      font-weight:600;
      color:#0d1326;
      background:#facc15;
      cursor:pointer;
    }
    .toast-host { position:fixed; bottom:24px; right:24px; display:flex; flex-direction:column; gap:8px; z-index:80; pointer-events:none; }
    .toast { background:#fff; color:#4a3523; border:1px solid rgba(0,0,0,.08); border-radius:999px; padding:10px 18px; opacity:0; transform:translateY(12px); box-shadow:0 20px 35px rgba(0,0,0,.22); transition:.3s; }
    .toast.show { opacity:1; transform:translateY(0); }
    @media(max-width:1100px){ .support-layout { grid-template-columns:1fr; } }
  </style>
  <script type="module">
    import {mountNav, mountAdminMenu, mountAdminUser, api, requireAuth} from '/app/app-common.js';

    const state = {
      status: 'ALL',
      keyword: '',
      mineOnly: false,
      threads: [],
      active: null,
      pollTimer: null,
    };

    const $ = (id) => document.getElementById(id);

    async function loadThreads() {
      const params = new URLSearchParams({ page: 0, size: 50 });
      if (state.status !== 'ALL') params.append('status', state.status);
      if (state.keyword.trim()) params.append('studentKeyword', state.keyword.trim());
      if (state.mineOnly) params.append('mineOnly', 'true');
      const query = params.toString() ? `?${params}` : '';
      const data = await api(`/api/support/manager/threads${query}`);
      state.threads = Array.isArray(data?.data) ? data.data : [];
      renderThreadList();
    }

    async function openThread(id, { silent } = {}) {
      if (!id) return;
      const detail = await api(`/api/support/threads/${id}`);
      state.active = detail;
      renderChat();
      if (!silent) {
        if (state.pollTimer) clearInterval(state.pollTimer);
        state.pollTimer = setInterval(() => openThread(id, { silent: true }), 4000);
      }
    }

    async function assignThread() {
      if (!state.active) return;
      await api(`/api/support/manager/threads/${state.active.id}/claim`, { method: 'POST' });
      await Promise.all([openThread(state.active.id), loadThreads()]);
    }

    async function changeStatus(status) {
      if (!state.active) return;
      await api(`/api/support/manager/threads/${state.active.id}/status`, {
        method: 'POST',
        body: JSON.stringify({ status }),
      });
      await Promise.all([openThread(state.active.id), loadThreads()]);
    }

    async function transferThread() {
      if (!state.active) return;
      const id = prompt('ID quản lý muốn chuyển');
      if (!id) return;
      await api(`/api/support/manager/threads/${state.active.id}/transfer`, {
        method: 'POST',
        body: JSON.stringify({ newManagerId: Number(id) }),
      });
      await Promise.all([openThread(state.active.id), loadThreads()]);
    }

    async function sendMessage(e) {
      e.preventDefault();
      if (!state.active) return;
      const content = $('messageInput').value.trim();
      if (!content) return;
      await api(`/api/support/manager/threads/${state.active.id}/messages`, {
        method: 'POST',
        body: JSON.stringify({ content }),
      });
      $('messageInput').value = '';
      await Promise.all([openThread(state.active.id, { silent: true }), loadThreads()]);
    }

    function renderThreadList() {
      $('threadCount').textContent = `${state.threads.length} hội thoại`;
      const host = $('threadList');
      host.innerHTML = state.threads
        .map(
          (thread) => `
        <button class="thread-item ${state.active?.id === thread.id ? 'is-active' : ''}" data-id="${thread.id}">
          <strong>${thread.student?.fullName || 'Học viên ẩn danh'}</strong>
          <small>${thread.courseTitle || 'Chưa gán khóa'} · ${thread.topic}</small>
          <small>${thread.status}</small>
        </button>
      `,
        )
        .join('') || '<div class="muted" style="padding:18px;color:#aab2d6">Chưa có hội thoại nào.</div>';
      host.querySelectorAll('button').forEach((btn) => btn.addEventListener('click', () => openThread(btn.dataset.id)));
    }

    function renderChat() {
      const header = $('chatHeader');
      const body = $('chatMessages');
      if (!state.active) {
        header.innerHTML = '<p class="muted">Chọn hội thoại ở cột bên trái để bắt đầu.</p>';
        body.innerHTML = '';
        return;
      }
      const t = state.active;
      header.innerHTML = `
        <div>
          <p class="muted">Hội thoại #${t.id}</p>
          <h2>${t.student?.fullName || 'Học viên ẩn danh'}</h2>
          <small>${t.courseTitle || 'Không rõ khóa'} · ${t.topic}</small>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="pill" onclick="window.assignThread()">Nhận xử lý</button>
          <button class="pill ghost" onclick="window.changeStatus('WAITING_STUDENT')">Chờ học viên</button>
          <button class="pill danger" onclick="window.changeStatus('CLOSED')">Đóng hội thoại</button>
          <button class="pill ghost" onclick="window.transferThread()">Chuyển</button>
        </div>`;

      body.innerHTML = (t.messages || [])
        .map((msg) => {
          let cls = 'msg msg-student';
          if (msg.senderType === 'manager') cls = 'msg msg-manager';
          if (msg.senderType === 'system') cls = 'msg msg-system';
          return `<div class="${cls}">
            <div class="muted" style="font-size:11px;margin-bottom:4px">${msg.sender?.fullName || msg.senderType}</div>
            <div>${msg.content.replace(/\n/g, '<br/>')}</div>
            ${renderAttachments(msg)}
            <div style="font-size:10px;margin-top:6px;opacity:.7;text-align:${msg.senderType === 'manager' ? 'right' : 'left'}">${new Date(msg.createdAt).toLocaleString('vi-VN')}</div>
          </div>`;
        })
        .join('');
      body.scrollTop = body.scrollHeight;
      $('messageInput').placeholder = `Trả lời ${t.student?.fullName || 'học viên'}...`;
    }

    function bindFilters() {
      $('statusSelect').addEventListener('change', (e) => {
        state.status = e.target.value;
        loadThreads();
      });
      $('keywordInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          state.keyword = e.target.value;
          loadThreads();
        }
      });
      $('keywordInput').addEventListener('blur', (e) => (state.keyword = e.target.value));
      $('mineToggle').addEventListener('change', (e) => {
        state.mineOnly = e.target.checked;
        loadThreads();
      });
      $('refreshBtn').addEventListener('click', loadThreads);
    }

    function toast(text) {
      const box = document.createElement('div');
      box.className = 'toast';
      box.textContent = text;
      $('toastHost').appendChild(box);
      setTimeout(() => box.classList.add('show'), 10);
      setTimeout(() => box.remove(), 4000);
    }

    function renderAttachments(msg){
      const attachments = msg.attachments || [];
      if(!attachments.length) return '';
      return `<div class="msg-attachments">
        ${attachments
          .map((url) =>
            /\.(png|jpg|jpeg|gif|bmp|webp|svg)$/i.test(url)
              ? `<a href="${url}" target="_blank" rel="noreferrer"><img src="${url}" alt="Đính kèm"/></a>`
              : `<a href="${url}" target="_blank" rel="noreferrer">Tải tệp đính kèm</a>`,
          )
          .join('')}
      </div>`;
    }

    window.assignThread = assignThread;
    window.changeStatus = changeStatus;
    window.transferThread = transferThread;

    window.addEventListener('DOMContentLoaded', () => {
      mountNav('nav', 'compact');
      mountAdminMenu('adminMenu', 'support-chat');
      mountAdminUser('adminUserCard');
      if (!requireAuth(['MANAGER'])) return;
      bindFilters();
      loadThreads();
      $('chatForm').addEventListener('submit', sendMessage);
      setInterval(loadThreads, 8000);
    });
  </script>
</head>
<body class="admin-body">
  <div class="admin-shell">
    <aside class="admin-sidebar">
      <div class="admin-brand">
        <span class="eyebrow">Bảng điều khiển</span>
        <strong>Quản lý LMS</strong>
        <p class="muted">Kênh hỗ trợ học viên</p>
      </div>
      <div id="adminUserCard" class="admin-user-card"></div>
      <nav id="adminMenu" class="admin-menu"></nav>
      <div class="admin-sidebar-footer">
        <a class="text-link" href="/app/index.html">← Về trang tổng quan</a>
      </div>
    </aside>
    <div class="admin-main">
      <div id="nav" data-variant="compact"></div>
      <main class="admin-content">
        <div class="admin-page-header">
          <p class="muted">Realtime Support</p>
          <h1>Chat học viên</h1>
          <p class="muted">Giữ liên lạc và xử lý yêu cầu tư vấn.</p>
        </div>
        <div class="support-layout">
          <div class="support-panel">
            <div class="queue-filters">
              <h2>Hàng đợi hỗ trợ</h2>
              <p class="muted" id="threadCount">0 hội thoại</p>
              <select id="statusSelect">
                <option value="ALL">Tất cả</option>
                <option value="NEW">Chưa nhận</option>
                <option value="IN_PROGRESS">Đang xử lý</option>
                <option value="WAITING_STUDENT">Chờ học viên</option>
                <option value="CLOSED">Đã đóng</option>
              </select>
              <input id="keywordInput" placeholder="Tìm học viên..." />
              <label><input type="checkbox" id="mineToggle"/> Chỉ hội thoại của tôi</label>
              <button type="button" id="refreshBtn">Làm mới</button>
            </div>
            <div id="threadList" class="thread-list"></div>
          </div>
          <div class="chat-shell">
            <div id="chatHeader" class="chat-header">
              <p class="muted">Chọn hội thoại ở cột bên trái để bắt đầu.</p>
            </div>
            <div id="chatMessages" class="chat-messages"></div>
            <form id="chatForm" class="chat-form">
              <textarea id="messageInput" placeholder="Nhập phản hồi..." ></textarea>
              <div style="text-align:right">
                <button type="submit">Gửi trả lời</button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>
    <div id="toastHost" class="toast-host"></div>
  </div>
</body>
</html>
