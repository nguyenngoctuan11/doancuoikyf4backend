<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tài liệu bài học</title>
  <link rel="stylesheet" href="/app/app.css"/>
  <script type="module">
    import { mountNav, mountAdminMenu, mountAdminUser, api, token } from '/app/app-common.js';

    const state = {
      courses: [],
      lessons: [],
      resources: [],
      filterCourse: '',
      filterLesson: '',
      filterStatus: '',
      loading: false,
      lessonsLoading: false,
      message: '',
      form: {
        title: '',
        description: '',
        type: 'file',
        visibility: 'enrolled',
        url: '',
        storagePath: '',
        fileInfo: null,
        externalUrl: '',
        uploading: false,
      },
    };

    function truncateType(value){
      const str = (value || '').toString();
      return str.length > 80 ? str.slice(0,80) : str;
    }

    function setState(patch) {
      Object.assign(state, patch);
      render();
    }

    function setForm(patch) {
      state.form = { ...state.form, ...patch };
      renderForm();
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatDate(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      return date.toLocaleString('vi-VN', { hour12: false });
    }

    function renderFilters() {
      const courseSelect = document.getElementById('filterCourse');
      if (courseSelect) {
        courseSelect.innerHTML = ['<option value="">Chọn khóa học</option>']
          .concat(
            state.courses.map(
              (c) => `<option value="${c.id}">${c.title || c.slug || 'Course #' + c.id}</option>`,
            ),
          )
          .join('');
        courseSelect.value = state.filterCourse || '';
      }
      const lessonSelect = document.getElementById('filterLesson');
      if (lessonSelect) {
        if (!state.lessons.length) {
          lessonSelect.innerHTML = '<option value="">Chưa có bài học</option>';
        } else {
          lessonSelect.innerHTML =
            '<option value="">Tất cả bài học</option>' +
            state.lessons
              .map((l) => `<option value="${l.id}">${l.title}</option>`)
              .join('');
        }
        lessonSelect.value = state.filterLesson || '';
      }
      const statusSelect = document.getElementById('filterStatus');
      if (statusSelect) {
        statusSelect.value = state.filterStatus || '';
      }
      const loadingIndicator = document.getElementById('lessonLoadingHint');
      if (loadingIndicator) {
        loadingIndicator.textContent = state.lessonsLoading ? 'Đang tải bài học...' : '';
      }
    }

    function renderSummary() {
      const total = state.resources.length;
      const pending = state.resources.filter((r) => (r.status || '').toLowerCase() === 'pending').length;
      const approved = state.resources.filter((r) => (r.status || '').toLowerCase() === 'approved').length;
      const rejected = state.resources.filter((r) => (r.status || '').toLowerCase() === 'rejected').length;
      const hidden = state.resources.filter((r) => (r.status || '').toLowerCase() === 'hidden').length;
      const map = {
        summaryTotal: total,
        summaryPending: pending,
        summaryApproved: approved,
        summaryRejected: rejected,
        summaryHidden: hidden,
        summaryHeroPending: pending,
        summaryHeroApproved: approved,
      };
      Object.entries(map).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      });
    }

    function renderResources() {
      const host = document.getElementById('resourceList');
      if (!host) return;
      if (!state.filterCourse || !state.filterLesson) {
        host.innerHTML =
          '<div class="empty">Chọn khóa học và bài học để xem danh sách tài liệu.</div>';
        return;
      }
      if (state.loading) {
        host.innerHTML = '<div class="empty">Đang tải danh sách...</div>';
        return;
      }
      if (!state.resources.length) {
        host.innerHTML =
          '<div class="empty empty-card">Chưa có tài liệu nào phù hợp bộ lọc.</div>';
        return;
      }
      host.innerHTML = state.resources
        .map((res) => {
          const status = (res.status || 'pending').toLowerCase();
          const badge =
            status === 'approved'
              ? 'badge-success'
              : status === 'rejected'
              ? 'badge-danger'
              : status === 'hidden'
              ? 'badge-ghost'
              : 'badge-warning';
          const statusLabel =
            {
              approved: 'Đã duyệt',
              rejected: 'Từ chối',
              hidden: 'Đã ẩn',
              pending: 'Đang chờ',
            }[status] || 'Đang chờ';
          const visibility = (res.visibility || 'enrolled').toLowerCase();
          const visibilityLabel =
            {
              enrolled: 'Học viên đã ghi danh',
              public: 'Công khai',
              instructors: 'Chỉ giảng viên',
            }[visibility] || visibility;
          const typeLabel = res.sourceType === 'link' ? 'Liên kết' : 'Tập tin';
          const owner = res.createdBy?.name || '---';
          const createdAt = formatDate(res.createdAt);
          return `
            <article class="card resource-card">
              <header class="resource-header">
                <div>
                  <p class="resource-title">${escapeHtml(res.title || 'Tài liệu')}</p>
                  <p class="muted tiny">${escapeHtml(res.description || '')}</p>
                  <div class="resource-meta">
                    <span>${typeLabel}</span>
                    <span>• Phạm vi: ${visibilityLabel}</span>
                    <span>• ${res.downloadCount || 0} lượt tải</span>
                  </div>
                  <div class="resource-meta">
                    <span>Người tạo: ${escapeHtml(owner)}</span>
                    ${createdAt ? `<span>• Tải lên ${createdAt}</span>` : ''}
                  </div>
                </div>
                <span class="badge ${badge}">${statusLabel}</span>
              </header>
              <footer class="resource-actions">
                <div class="action-buttons">
                  <button class="btn btn-xs ghost" data-action="open" data-id="${res.id}">Xem</button>
                  <button class="btn btn-xs" data-action="approve" data-id="${res.id}">Duyệt</button>
                  <button class="btn btn-xs danger" data-action="reject" data-id="${res.id}">Từ chối</button>
                  <button class="btn btn-xs border-stone-300" data-action="hide" data-id="${res.id}">${
                    status === 'hidden' ? 'Hiển thị' : 'Ẩn nhanh'
                  }</button>
                </div>
              </footer>
            </article>
          `;
        })
        .join('');
      host.querySelectorAll('button[data-action]').forEach((btn) => {
        btn.addEventListener('click', (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          const action = ev.currentTarget.getAttribute('data-action');
          if (action === 'open') {
            openResource(id);
            return;
          }
          if (action === 'hide') {
            const targetStatus =
              state.resources.find((r) => String(r.id) === String(id))?.status === 'hidden' ? 'pending' : 'hidden';
            changeStatus(id, targetStatus);
            return;
          }
          const map = { approve: 'approved', reject: 'rejected' };
          changeStatus(id, map[action]);
        });
      });
    }

    function renderForm() {
      const formTitle = document.getElementById('formTitle');
      if (formTitle) formTitle.value = state.form.title || '';
      const formDescription = document.getElementById('formDescription');
      if (formDescription) formDescription.value = state.form.description || '';
      const formType = document.getElementById('formType');
      if (formType) formType.value = state.form.type || 'file';
      const formVisibility = document.getElementById('formVisibility');
      if (formVisibility) formVisibility.value = state.form.visibility || 'enrolled';
      const formLink = document.getElementById('formExternal');
      if (formLink) formLink.value = state.form.externalUrl || '';
      const uploadInfo = document.getElementById('uploadInfo');
      if (uploadInfo) {
        uploadInfo.textContent = state.form.fileInfo
          ? `Đã tải: ${state.form.fileInfo.name || 'file'}`
          : '';
      }
      document.getElementById('fileFields').style.display = state.form.type === 'file' ? 'block' : 'none';
      document.getElementById('linkFields').style.display = state.form.type === 'link' ? 'block' : 'none';
    }

    async function fetchCourses() {
      try {
        const list = await api('/api/teacher/courses?status=published');
        setState({ courses: Array.isArray(list) ? list : [] });
      } catch (err) {
        setState({ courses: [] });
        alert(err?.message || 'Không tải được danh sách khóa học');
      }
    }

    async function fetchLessons(courseId) {
      if (!courseId) {
        setState({ lessons: [], filterLesson: '' });
        return;
      }
      setState({ lessonsLoading: true, lessons: [], filterLesson: '' });
      try {
        const res = await fetch(`/api/public/courses/${courseId}/detail-sql`);
        const data = await res.json();
        const lessons =
          (data.modules || []).flatMap((mod) =>
            (mod.lessons || []).map((lesson) => ({
              id: lesson.id,
              title: `${mod.title || 'Module'} - ${lesson.title || 'Lesson'}`,
            })),
          ) || [];
        setState({ lessons, lessonsLoading: false });
      } catch {
        setState({ lessons: [], lessonsLoading: false });
        alert('Không tải được bài học.');
      }
    }

    async function fetchResources() {
      if (!state.filterCourse || !state.filterLesson) {
        setState({ resources: [], message: '' });
        renderResources();
        return;
      }
      setState({ loading: true, message: '' });
      try {
        const list = await api(
          `/api/teacher/lesson-resources/courses/${state.filterCourse}/lessons/${state.filterLesson}`,
        );
        let data = Array.isArray(list) ? list : [];
        if (state.filterStatus) {
          const filter = state.filterStatus.toLowerCase();
          data = data.filter((item) => (item.status || '').toLowerCase() === filter);
        }
        setState({ resources: data, loading: false });
      } catch (err) {
        setState({ resources: [], loading: false });
        alert(err?.message || 'Không tải được tài liệu');
      }
    }

    async function changeStatus(id, status) {
      if (!id || !status) return;
      try {
        await api(`/api/teacher/lesson-resources/${id}/status`, {
          method: 'PATCH',
          body: JSON.stringify({ status }),
        });
        fetchResources();
      } catch (err) {
        alert(err?.message || 'Không thể cập nhật trạng thái');
      }
    }

    async function openResource(id) {
      try {
        const res = await api(`/api/lesson-resources/${id}/download`);
        const url = res?.redirectUrl;
        if (url) {
          const absolute = url.startsWith('http') ? url : `${location.origin}${url}`;
          window.open(absolute, '_blank');
        } else {
          alert('Không tìm thấy đường dẫn tài liệu');
        }
      } catch (err) {
        alert(err?.message || 'Không thể mở tài liệu');
      }
    }

    async function handleUpload(file) {
      if (!file) return;
      if (!token()) {
        alert('Cần đăng nhập');
        return;
      }
      setForm({ uploading: true });
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch('/api/upload/file', {
          method: 'POST',
          headers: { Authorization: `Bearer ${token()}` },
          body: formData,
        });
        if (!res.ok) {
          throw new Error('Upload failed');
        }
        const data = await res.json();
        setForm({
          uploading: false,
          fileInfo: { name: file.name, size: file.size, contentType: file.type },
          storagePath: data.path,
          url: data.url,
        });
      } catch (err) {
        setForm({ uploading: false, fileInfo: null, storagePath: '', url: '' });
        alert(err?.message || 'Upload không thành công');
      }
    }

    async function submitResource() {
      if (!state.filterCourse || !state.filterLesson) {
        alert('Chèn khóa học vào bài học trước khi tải lên.');
        return;
      }
      const title = state.form.title.trim();
      if (!title) {
        alert('Nhập tiêu đề tài liệu');
        return;
      }
      const body = {
        title,
        description: state.form.description,
        sourceType: state.form.type,
        visibility: state.form.visibility,
      };
      if (state.form.type === 'file') {
        if (!state.form.storagePath || !state.form.url) {
          alert('Hãy tiếp tục trước khi lưu.');
          return;
        }
        body.storagePath = state.form.storagePath;
        body.fileUrl = state.form.url;
        body.fileType = truncateType(state.form.fileInfo?.contentType);
        body.fileSize = state.form.fileInfo?.size;
      } else {
        if (!state.form.externalUrl.trim()) {
          alert('Nhập đường dẫn liên kết');
          return;
        }
        body.externalUrl = state.form.externalUrl.trim();
      }
      try {
        await api(`/api/teacher/lesson-resources/courses/${state.filterCourse}/lessons/${state.filterLesson}`, {
          method: 'POST',
          body: JSON.stringify(body),
        });
        alert('Đã thêm tài liệu (đang chờ duyệt).');
        setForm({
          title: '',
          description: '',
          type: state.form.type,
          visibility: state.form.visibility,
          url: '',
          storagePath: '',
          fileInfo: null,
          externalUrl: '',
          uploading: false,
        });
        fetchResources();
      } catch (err) {
        alert(err?.message || 'Không thể thêm tài liệu');
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      mountNav('nav', 'compact');
      mountAdminMenu('adminMenu', 'teacher-resources');
      mountAdminUser('adminUserCard');
      document.getElementById('filterCourse').addEventListener('change', (e) => {
        setState({ filterCourse: e.target.value, filterLesson: '' });
        fetchLessons(e.target.value);
      });
      document.getElementById('filterLesson').addEventListener('change', (e) => {
        setState({ filterLesson: e.target.value });
      });
      document.getElementById('filterStatus').addEventListener('change', (e) => {
        setState({ filterStatus: e.target.value });
      });
      document.getElementById('btnApply').addEventListener('click', fetchResources);
      document.getElementById('btnRefresh').addEventListener('click', fetchResources);
      document.getElementById('formType').addEventListener('change', (e) => {
        setForm({ type: e.target.value });
      });
      document.getElementById('formVisibility').addEventListener('change', (e) => {
        setForm({ visibility: e.target.value });
      });
      document.getElementById('formTitle').addEventListener('input', (e) => setForm({ title: e.target.value }));
      document.getElementById('formDescription').addEventListener('input', (e) =>
        setForm({ description: e.target.value }),
      );
      document.getElementById('formExternal').addEventListener('input', (e) =>
        setForm({ externalUrl: e.target.value }),
      );
      document.getElementById('resourceFile').addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (file) {
          handleUpload(file);
        }
      });
      document.getElementById('btnSubmitResource').addEventListener('click', submitResource);
      fetchCourses();
    });

    function render() {
      renderFilters();
      renderResources();
      renderSummary();
      renderForm();
    }
  </script>
  <style>
    .page-stats{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      margin-top:12px;
    }
    .page-stats .stat-pill{
      min-width:140px;
      padding:14px 18px;
      border-radius:20px;
      border:1px solid rgba(234,223,209,.85);
      background:#fff;
      box-shadow:var(--shadow-soft);
    }
    .page-stats .stat-pill span{
      display:block;
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--text-muted);
    }
    .page-stats .stat-pill strong{
      display:block;
      font-size:1.6rem;
      margin-top:6px;
      color:var(--accent-strong);
    }
    .section-heading{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom:18px;
    }
    .section-heading h2,
    .section-heading h3{
      margin:0;
      color:var(--text);
    }
    .section-heading p{
      margin:6px 0 0;
      color:var(--text-muted);
    }
    .section-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .filter-grid{
      display:grid;
      gap:16px;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }
    .filter-grid label{
      font-size:.85rem;
      font-weight:600;
      color:var(--text-muted);
    }
    .resource-layout{
      display:grid;
      gap:24px;
    }
    @media (min-width:1024px){
      .resource-layout{grid-template-columns:1.2fr .8fr}
    }
    .resource-list{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .resource-item{
      border:1px solid rgba(234,223,209,.9);
      border-radius:20px;
      padding:18px 20px;
      background:#fffdf9;
      box-shadow:0 18px 30px rgba(165,112,70,.12);
    }
    .resource-item header{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .resource-item h4{
      margin:0;
      font-size:1.05rem;
      color:var(--text);
    }
    .resource-item .meta{
      margin-top:6px;
      font-size:.85rem;
      color:var(--text-muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .resource-item footer{
      margin-top:16px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .action-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .badge-success{background:#ecfdf5;color:#047857;}
    .badge-warning{background:#fff7ed;color:#c2410c;}
    .badge-danger{background:#fee2e2;color:#b91c1c;}
    .badge-ghost{background:#f1f5f9;color:#475569;}
    .resource-form{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .resource-form .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .resource-form label{
      font-size:.85rem;
      font-weight:600;
      color:var(--text-muted);
    }
    .resource-form textarea{
      min-height:90px;
      resize:vertical;
    }
    .form-note{
      font-size:.8rem;
      color:var(--text-muted);
      margin:4px 0 0;
    }
    .upload-area{
      border:1px dashed rgba(186,132,82,.5);
      border-radius:16px;
      padding:16px;
      text-align:center;
      cursor:pointer;
      background:#fff9f3;
      transition:border .2s ease,background .2s ease;
    }
    .upload-area:hover{
      border-color:var(--accent);
      background:#fff;
    }
    .tiny-note{font-size:.78rem;color:var(--text-muted);}
  </style>
</head>
<body class="admin-body">
  <div class="admin-shell">
    <aside class="admin-sidebar">
      <div class="admin-brand">
        <span class="eyebrow">Không gian giảng viên</span>
        <strong>Tài liệu bài học</strong>
        <p class="muted">Theo dõi tài nguyên từng bài học, duyệt yêu cầu và tải lên tài liệu mới cho học viên.</p>
      </div>
      <div id="adminUserCard" class="admin-user-card"></div>
      <nav id="adminMenu" class="admin-menu"></nav>
      <div class="admin-sidebar-footer">
        <a class="text-link" href="/app/index.html">← Về trang tổng quan</a>
      </div>
    </aside>

    <div class="admin-main">
      <div id="nav" data-variant="compact"></div>
      <main class="admin-content page-shell">
        <header class="page-header">
          <span class="eyebrow">Studio giảng viên</span>
          <h1>Kho tài liệu bài học</h1>
          <p>Tập trung những file quan trọng cho từng bài giảng, lọc nhanh theo khóa và trạng thái để xử lý trong vài cú click.</p>
          <div class="page-stats">
            <div class="stat-pill">
              <span>Đang chờ</span>
              <strong id="summaryHeroPending">0</strong>
            </div>
            <div class="stat-pill">
              <span>Đã duyệt</span>
              <strong id="summaryHeroApproved">0</strong>
            </div>
          </div>
        </header>

        <section class="metric-grid">
          <div class="metric-card">
            <span>Tổng tài liệu</span>
            <strong id="summaryTotal">0</strong>
          </div>
          <div class="metric-card">
            <span>Đang chờ</span>
            <strong id="summaryPending">0</strong>
          </div>
          <div class="metric-card">
            <span>Đã duyệt</span>
            <strong id="summaryApproved">0</strong>
          </div>
          <div class="metric-card">
            <span>Từ chối</span>
            <strong id="summaryRejected">0</strong>
          </div>
          <div class="metric-card">
            <span>Đang ẩn</span>
            <strong id="summaryHidden">0</strong>
          </div>
        </section>

        <section class="section-card">
          <header class="section-heading">
            <div>
              <h2>Bộ lọc tài liệu</h2>
              <p class="small">Chọn khóa, bài và trạng thái để hiển thị đúng nội dung cần xử lý.</p>
            </div>
            <div class="section-actions">
              <button id="btnApply" class="btn">Lọc kết quả</button>
              <button id="btnRefresh" class="btn ghost">Làm mới</button>
            </div>
          </header>
          <div class="filter-grid">
            <div>
              <label for="filterCourse">Khóa học</label>
              <select id="filterCourse" class="input"></select>
              <p id="lessonLoadingHint" class="tiny-note"></p>
            </div>
            <div>
              <label for="filterLesson">Bài học</label>
              <select id="filterLesson" class="input">
                <option value="">Chọn khóa học trước</option>
              </select>
            </div>
            <div>
              <label for="filterStatus">Trạng thái</label>
              <select id="filterStatus" class="input">
                <option value="">Tất cả</option>
                <option value="pending">Đang chờ</option>
                <option value="approved">Đã duyệt</option>
                <option value="rejected">Từ chối</option>
                <option value="hidden">Đang ẩn</option>
              </select>
            </div>
          </div>
        </section>

        <section class="resource-layout">
          <div class="section-card">
            <header class="section-heading">
              <div>
                <h3>Danh sách tài liệu</h3>
                <p class="small">Cập nhật khi thay đổi bộ lọc.</p>
              </div>
            </header>
            <div id="resourceList" class="resource-list">
              <div class="empty">Chọn khóa học và bài học để xem tài liệu.</div>
            </div>
          </div>

          <div class="section-card resource-form">
            <header class="section-heading">
              <div>
                <h3>Thêm tài liệu</h3>
                <p class="small">Upload nhanh file mới hoặc dán liên kết.</p>
              </div>
            </header>
            <div class="field">
              <label for="formTitle">Tiêu đề</label>
              <input id="formTitle" class="input" placeholder="VD: Slide bài 3" />
            </div>
            <div class="field">
              <label for="formDescription">Mô tả</label>
              <textarea id="formDescription" class="input" placeholder="Mô tả ngắn gọn nội dung tài liệu"></textarea>
            </div>
            <div class="filter-grid">
              <div class="field">
                <label for="formType">Hình thức</label>
                <select id="formType" class="input">
                  <option value="file">Tệp tải lên</option>
                  <option value="link">Liên kết ngoài</option>
                </select>
              </div>
              <div class="field">
                <label for="formVisibility">Phạm vi hiển thị</label>
                <select id="formVisibility" class="input">
                  <option value="enrolled">Học viên đã ghi danh</option>
                  <option value="public">Công khai</option>
                  <option value="instructors">Chỉ giảng viên</option>
                </select>
              </div>
            </div>
            <div id="fileFields" class="field" style="display:block;">
              <label for="resourceFile">Tệp đính kèm</label>
              <label class="upload-area">
                <span>Tải tài liệu từ máy của bạn</span>
                <input id="resourceFile" type="file" />
              </label>
              <p id="uploadInfo" class="form-note"></p>
            </div>
            <div id="linkFields" class="field" style="display:none;">
              <label for="formExternal">Đường dẫn</label>
              <input id="formExternal" class="input" type="url" placeholder="https://..." />
              <p class="form-note">Đảm bảo người học có quyền truy cập liên kết này.</p>
            </div>
            <button id="btnSubmitResource" class="btn" type="button">Đăng tài liệu</button>
            <p class="form-note">Nhớ chọn khóa học & bài học trước khi lưu.</p>
          </div>
        </section>
      </main>
    </div>

  </div>
</body>
</html>
