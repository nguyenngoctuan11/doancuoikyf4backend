<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tài li?u bài h?c</title>
  <link rel="stylesheet" href="/app/app.css"/>
  <script type="module">
    import { mountNav, mountAdminMenu, mountAdminUser, api, token } from '/app/app-common.js';

    const state = {
      courses: [],
      lessons: [],
      resources: [],
      filterCourse: '',
      filterLesson: '',
      filterStatus: '',
      loading: false,
      lessonsLoading: false,
      message: '',
      form: {
        title: '',
        description: '',
        type: 'file',
        visibility: 'enrolled',
        url: '',
        storagePath: '',
        fileInfo: null,
        externalUrl: '',
        uploading: false,
      },
    };

    function setState(patch) {
      Object.assign(state, patch);
      render();
    }

    function setForm(patch) {
      state.form = { ...state.form, ...patch };
      renderForm();
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatDate(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      return date.toLocaleString('vi-VN', { hour12: false });
    }

    function renderFilters() {
      const courseSelect = document.getElementById('filterCourse');
      if (courseSelect) {
        courseSelect.innerHTML = ['<option value="">Ch?n khóa h?c</option>']
          .concat(
            state.courses.map(
              (c) => `<option value="${c.id}">${c.title || c.slug || 'Course #' + c.id}</option>`,
            ),
          )
          .join('');
        courseSelect.value = state.filterCourse || '';
      }
      const lessonSelect = document.getElementById('filterLesson');
      if (lessonSelect) {
        if (!state.lessons.length) {
          lessonSelect.innerHTML = '<option value="">Chua có bài h?c</option>';
        } else {
          lessonSelect.innerHTML =
            '<option value="">T?t c? bài h?c</option>' +
            state.lessons
              .map((l) => `<option value="${l.id}">${l.title}</option>`)
              .join('');
        }
        lessonSelect.value = state.filterLesson || '';
      }
      const statusSelect = document.getElementById('filterStatus');
      if (statusSelect) {
        statusSelect.value = state.filterStatus || '';
      }
      const loadingIndicator = document.getElementById('lessonLoadingHint');
      if (loadingIndicator) {
        loadingIndicator.textContent = state.lessonsLoading ? 'Ðang t?i bài h?c...' : '';
      }
    }

    function renderSummary() {
      const total = state.resources.length;
      const pending = state.resources.filter((r) => (r.status || '').toLowerCase() === 'pending').length;
      const approved = state.resources.filter((r) => (r.status || '').toLowerCase() === 'approved').length;
      const rejected = state.resources.filter((r) => (r.status || '').toLowerCase() === 'rejected').length;
      const hidden = state.resources.filter((r) => (r.status || '').toLowerCase() === 'hidden').length;
      const map = {
        summaryTotal: total,
        summaryPending: pending,
        summaryApproved: approved,
        summaryRejected: rejected,
        summaryHidden: hidden,
        summaryHeroPending: pending,
        summaryHeroApproved: approved,
      };
      Object.entries(map).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      });
    }

    function renderResources() {
      const host = document.getElementById('resourceList');
      if (!host) return;
      if (!state.filterCourse || !state.filterLesson) {
        host.innerHTML =
          '<div class="empty">Ch?n khóa h?c và bài h?c d? xem danh sách tài li?u.</div>';
        return;
      }
      if (state.loading) {
        host.innerHTML = '<div class="empty">Ðang t?i danh sách...</div>';
        return;
      }
      if (!state.resources.length) {
        host.innerHTML =
          '<div class="empty empty-card">Chua có tài li?u nào phù h?p b? l?c.</div>';
        return;
      }
      host.innerHTML = state.resources
        .map((res) => {
          const status = (res.status || 'pending').toLowerCase();
          const badge =
            status === 'approved'
              ? 'badge-success'
              : status === 'rejected'
              ? 'badge-danger'
              : status === 'hidden'
              ? 'badge-ghost'
              : 'badge-warning';
          const statusLabel =
            {
              approved: 'Ðã duy?t',
              rejected: 'T? ch?i',
              hidden: 'Ðã ?n',
              pending: 'Ðang ch?',
            }[status] || 'Ðang ch?';
          const visibility = (res.visibility || 'enrolled').toLowerCase();
          const visibilityLabel =
            {
              enrolled: 'H?c viên dã ghi danh',
              public: 'Công khai',
              instructors: 'Ch? gi?ng viên',
            }[visibility] || visibility;
          const typeLabel = res.sourceType === 'link' ? 'Liên k?t' : 'T?p tin';
          const owner = res.createdBy?.name || '---';
          const createdAt = formatDate(res.createdAt);
          return `
            <article class="card resource-card">
              <header class="resource-header">
                <div>
                  <p class="resource-title">${escapeHtml(res.title || 'Tài li?u')}</p>
                  <p class="muted tiny">${escapeHtml(res.description || '')}</p>
                  <div class="resource-meta">
                    <span>${typeLabel}</span>
                    <span>• Ph?m vi: ${visibilityLabel}</span>
                    <span>• ${res.downloadCount || 0} lu?t t?i</span>
                  </div>
                  <div class="resource-meta">
                    <span>Ngu?i t?o: ${escapeHtml(owner)}</span>
                    ${createdAt ? `<span>• T?i lên ${createdAt}</span>` : ''}
                  </div>
                </div>
                <span class="badge ${badge}">${statusLabel}</span>
              </header>
              <footer class="resource-actions">
                <div class="action-buttons">
                  <button class="btn btn-xs ghost" data-action="open" data-id="${res.id}">Xem</button>
                  <button class="btn btn-xs" data-action="approve" data-id="${res.id}">Duy?t</button>
                  <button class="btn btn-xs danger" data-action="reject" data-id="${res.id}">T? ch?i</button>
                  <button class="btn btn-xs border-stone-300" data-action="hide" data-id="${res.id}">${
                    status === 'hidden' ? 'Hi?n th?' : '?n nhanh'
                  }</button>
                </div>
              </footer>
            </article>
          `;
        })
        .join('');
      host.querySelectorAll('button[data-action]').forEach((btn) => {
        btn.addEventListener('click', (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          const action = ev.currentTarget.getAttribute('data-action');
          if (action === 'open') {
            openResource(id);
            return;
          }
          if (action === 'hide') {
            const targetStatus =
              state.resources.find((r) => String(r.id) === String(id))?.status === 'hidden' ? 'pending' : 'hidden';
            changeStatus(id, targetStatus);
            return;
          }
          const map = { approve: 'approved', reject: 'rejected' };
          changeStatus(id, map[action]);
        });
      });
    }

    function renderForm() {
      const formTitle = document.getElementById('formTitle');
      if (formTitle) formTitle.value = state.form.title || '';
      const formDescription = document.getElementById('formDescription');
      if (formDescription) formDescription.value = state.form.description || '';
      const formType = document.getElementById('formType');
      if (formType) formType.value = state.form.type || 'file';
      const formVisibility = document.getElementById('formVisibility');
      if (formVisibility) formVisibility.value = state.form.visibility || 'enrolled';
      const formLink = document.getElementById('formExternal');
      if (formLink) formLink.value = state.form.externalUrl || '';
      const uploadInfo = document.getElementById('uploadInfo');
      if (uploadInfo) {
        uploadInfo.textContent = state.form.fileInfo
          ? `Ðã t?i: ${state.form.fileInfo.name || 'file'}`
          : '';
      }
      document.getElementById('fileFields').style.display = state.form.type === 'file' ? 'block' : 'none';
      document.getElementById('linkFields').style.display = state.form.type === 'link' ? 'block' : 'none';
    }

    async function fetchCourses() {
      try {
        const list = await api('/api/teacher/courses?status=published');
        setState({ courses: Array.isArray(list) ? list : [] });
      } catch (err) {
        setState({ courses: [] });
        alert(err?.message || 'Không t?i du?c danh sách khóa h?c');
      }
    }

    async function fetchLessons(courseId) {
      if (!courseId) {
        setState({ lessons: [], filterLesson: '' });
        return;
      }
      setState({ lessonsLoading: true, lessons: [], filterLesson: '' });
      try {
        const res = await fetch(`/api/public/courses/${courseId}/detail-sql`);
        const data = await res.json();
        const lessons =
          (data.modules || []).flatMap((mod) =>
            (mod.lessons || []).map((lesson) => ({
              id: lesson.id,
              title: `${mod.title || 'Module'} - ${lesson.title || 'Lesson'}`,
            })),
          ) || [];
        setState({ lessons, lessonsLoading: false });
      } catch {
        setState({ lessons: [], lessonsLoading: false });
        alert('Không t?i du?c bài h?c.');
      }
    }

    async function fetchResources() {
      if (!state.filterCourse || !state.filterLesson) {
        setState({ resources: [], message: '' });
        renderResources();
        return;
      }
      setState({ loading: true, message: '' });
      try {
        const list = await api(
          `/api/teacher/lesson-resources/courses/${state.filterCourse}/lessons/${state.filterLesson}`,
        );
        let data = Array.isArray(list) ? list : [];
        if (state.filterStatus) {
          const filter = state.filterStatus.toLowerCase();
          data = data.filter((item) => (item.status || '').toLowerCase() === filter);
        }
        setState({ resources: data, loading: false });
      } catch (err) {
        setState({ resources: [], loading: false });
        alert(err?.message || 'Không t?i du?c tài li?u');
      }
    }

    async function changeStatus(id, status) {
      if (!id || !status) return;
      try {
        await api(`/api/teacher/lesson-resources/${id}/status`, {
          method: 'PATCH',
          body: JSON.stringify({ status }),
        });
        fetchResources();
      } catch (err) {
        alert(err?.message || 'Không th? c?p nh?t tr?ng thái');
      }
    }

    async function openResource(id) {
      try {
        const res = await api(`/api/lesson-resources/${id}/download`);
        const url = res?.redirectUrl;
        if (url) {
          const absolute = url.startsWith('http') ? url : `${location.origin}${url}`;
          window.open(absolute, '_blank');
        } else {
          alert('Không tìm th?y du?ng d?n tài li?u');
        }
      } catch (err) {
        alert(err?.message || 'Không th? m? tài li?u');
      }
    }

    async function handleUpload(file) {
      if (!file) return;
      if (!token()) {
        alert('C?n dang nh?p');
        return;
      }
      setForm({ uploading: true });
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch('/api/upload/file', {
          method: 'POST',
          headers: { Authorization: `Bearer ${token()}` },
          body: formData,
        });
        if (!res.ok) {
          throw new Error('Upload failed');
        }
        const data = await res.json();
        setForm({
          uploading: false,
          fileInfo: { name: file.name, size: file.size, contentType: file.type },
          storagePath: data.path,
          url: data.url,
        });
      } catch (err) {
        setForm({ uploading: false, fileInfo: null, storagePath: '', url: '' });
        alert(err?.message || 'Upload không thành công');
      }
    }

    async function submitResource() {
      if (!state.filterCourse || !state.filterLesson) {
        alert('Ch?n khóa h?c và bài h?c tru?c khi t?i lên.');
        return;
      }
      const title = state.form.title.trim();
      if (!title) {
        alert('Nh?p tiêu d? tài li?u');
        return;
      }
      const body = {
        title,
        description: state.form.description,
        sourceType: state.form.type,
        visibility: state.form.visibility,
      };
      if (state.form.type === 'file') {
        if (!state.form.storagePath || !state.form.url) {
          alert('Hãy t?i t?p tru?c khi luu.');
          return;
        }
        body.storagePath = state.form.storagePath;
        body.fileUrl = state.form.url;
        body.fileType = state.form.fileInfo?.contentType;
        body.fileSize = state.form.fileInfo?.size;
      } else {
        if (!state.form.externalUrl.trim()) {
          alert('Nh?p du?ng d?n liên k?t');
          return;
        }
        body.externalUrl = state.form.externalUrl.trim();
      }
      try {
        await api(`/api/teacher/lesson-resources/courses/${state.filterCourse}/lessons/${state.filterLesson}`, {
          method: 'POST',
          body: JSON.stringify(body),
        });
        alert('Ðã thêm tài li?u (dang ch? duy?t).');
        setForm({
          title: '',
          description: '',
          type: state.form.type,
          visibility: state.form.visibility,
          url: '',
          storagePath: '',
          fileInfo: null,
          externalUrl: '',
          uploading: false,
        });
        fetchResources();
      } catch (err) {
        alert(err?.message || 'Không th? thêm tài li?u');
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      mountNav('nav', 'compact');
      mountAdminMenu('adminMenu', 'teacher-resources');
      mountAdminUser('adminUserCard');
      document.getElementById('filterCourse').addEventListener('change', (e) => {
        setState({ filterCourse: e.target.value, filterLesson: '' });
        fetchLessons(e.target.value);
      });
      document.getElementById('filterLesson').addEventListener('change', (e) => {
        setState({ filterLesson: e.target.value });
      });
      document.getElementById('filterStatus').addEventListener('change', (e) => {
        setState({ filterStatus: e.target.value });
      });
      document.getElementById('btnApply').addEventListener('click', fetchResources);
      document.getElementById('btnRefresh').addEventListener('click', fetchResources);
      document.getElementById('formType').addEventListener('change', (e) => {
        setForm({ type: e.target.value });
      });
      document.getElementById('formVisibility').addEventListener('change', (e) => {
        setForm({ visibility: e.target.value });
      });
      document.getElementById('formTitle').addEventListener('input', (e) => setForm({ title: e.target.value }));
      document.getElementById('formDescription').addEventListener('input', (e) =>
        setForm({ description: e.target.value }),
      );
      document.getElementById('formExternal').addEventListener('input', (e) =>
        setForm({ externalUrl: e.target.value }),
      );
      document.getElementById('resourceFile').addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (file) {
          handleUpload(file);
        }
      });
      document.getElementById('btnSubmitResource').addEventListener('click', submitResource);
      fetchCourses();
    });

    function render() {
      renderFilters();
      renderResources();
      renderSummary();
      renderForm();
    }
  </script>
  <style>
    .hero-card { position:relative; overflow:hidden; border-radius:28px; padding:32px; background:linear-gradient(135deg, rgba(94,96,255,0.12), rgba(64,18,136,0.55)); border:1px solid rgba(148,163,184,0.25); box-shadow:0 25px 60px rgba(8,11,22,0.55); display:grid; gap:24px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
    .hero-card::after { content:''; position:absolute; inset:0; background:radial-gradient(circle at 15% 20%, rgba(255,255,255,0.08), transparent 45%); pointer-events:none; }
    .hero-card > * { position:relative; }
    .hero-eyebrow { text-transform:uppercase; font-size:0.75rem; letter-spacing:0.3em; color:#c7d2fe; margin-bottom:10px; display:block; }
    .hero-title { font-size: clamp(1.8rem, 3vw, 2.6rem); color:#fff; margin-bottom:12px; }
    .hero-text { color:#e0e7ff; max-width:50ch; }
    .hero-tags { display:flex; flex-wrap:wrap; gap:10px; margin-top:18px; }
    .hero-tags span { background:rgba(255,255,255,0.16); border:1px solid rgba(255,255,255,0.3); color:#f8fafc; padding:6px 12px; border-radius:999px; font-size:0.85rem; }
    .hero-side { background:rgba(15,23,42,0.45); border:1px solid rgba(148,163,184,0.2); border-radius:22px; padding:20px; color:#f8fafc; }
    .hero-checklist { list-style:none; padding:0; margin:12px 0 0; display:flex; flex-direction:column; gap:8px; }
    .hero-checklist li { font-size:0.9rem; color:#e2e8f0; padding-left:20px; position:relative; }
    .hero-checklist li::before { content:'•'; position:absolute; left:0; color:#a5b4fc; }
    .hero-progress { margin-top:18px; display:flex; gap:20px; align-items:flex-end; flex-wrap:wrap; }
    .hero-number { font-size:2.2rem; font-weight:600; color:#fff; display:block; }
    .hero-note { color:#c7d2fe; margin:4px 0 0; }

    .filters-card { position:relative; background: radial-gradient(circle at top left, rgba(99,102,241,0.2), rgba(15,23,42,0.95)); border: 1px solid rgba(148,163,184,0.25); box-shadow: 0 20px 50px rgba(10,12,25,0.45); border-radius: 24px; padding: 20px; overflow:hidden; }
    .filters-card::before { content:''; position:absolute; inset:0; background:radial-gradient(circle at 80% 20%, rgba(255,255,255,0.05), transparent 50%); pointer-events:none; }
    .filters-card .input { background:rgba(15,23,42,0.65); border:1px solid rgba(255,255,255,0.12); color:#f8fafc; }
    .filters-card select.input option { color:#0f172a; }

    .summary-grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); }
    .stat-card { border-radius:22px; padding:18px; background:rgba(15,23,42,0.85); border:1px solid rgba(148,163,184,0.2); color:#e2e8f0; box-shadow:0 20px 45px rgba(15,23,42,0.45); }
    .stat-value { font-size:1.8rem; font-weight:600; color:#fefefe; margin-top:4px; }

    .resource-layout { display:grid; gap:20px; }
    @media (min-width: 1024px) { .resource-layout { grid-template-columns: 1.5fr 1fr; } }

    .resource-card { border-radius: 18px; border: 1px solid rgba(148,163,184,0.25); padding: 20px; background: #fff; box-shadow: 0 15px 40px rgba(15,23,42,0.15); }
    .resource-header { display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .resource-title { font-size:1.
