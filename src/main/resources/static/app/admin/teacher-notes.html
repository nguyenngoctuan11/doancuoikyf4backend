<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Qu&#7843;n l&#253; ghi ch&#250; b&#224;i h&#7885;c</title>
  <link rel="stylesheet" href="/app/app.css"/>
  <script type="module">
    import {mountNav, mountAdminMenu, mountAdminUser, api, token} from '/app/app-common.js';

    const qs = (selector) => document.querySelector(selector);
    const qsa = (selector) => Array.from(document.querySelectorAll(selector));

    const state = {
      courses: [],
      notes: [],
      filterCourse: '',
      filterStatus: '',
      search: '',
      loading: false,
      detail: null,
      replyText: '',
      replying: false,
    };

    const statusLabels = {
      pending: 'Ch&#432;a ph&#7843;n h&#7891;i',
      resolved: '&#272;&#227; ph&#7843;n h&#7891;i',
    };

    function setState(patch) {
      Object.assign(state, patch);
      render();
    }

    function renderFilters() {
      const courseSelect = qs('#filterCourse');
      courseSelect.innerHTML = `<option value="">T&#7845;t c&#7843; kh&#243;a h&#7885;c</option>` + state.courses.map(c => `<option value="${c.id}">${c.title || c.slug || ('Kho&#225; #' + c.id)}</option>`).join('');
      courseSelect.value = state.filterCourse || '';

      const statusSelect = qs('#filterStatus');
      statusSelect.value = state.filterStatus || '';
      qs('#searchInput').value = state.search || '';
    }

    function renderNotes() {
      const list = qs('#notesList');
      list.innerHTML = '';
      if (state.loading) {
        list.innerHTML = '<div class="empty">&#272;ang t&#7843;i d&#7919; li&#7879;u...</div>';
        return;
      }
      if (!state.notes.length) {
        list.innerHTML = '<div class="empty empty-card"><p>Ch&#432;a c&#243; ghi ch&#250; n&#224;o kh&#7899;p b&#7897; l&#7885;c. H&#227;y thay &#273;&#7893;i &#273;i&#7873;u ki&#7879;n ho&#7863;c nh&#7855;c h&#7885;c vi&#234;n &#273;&#7875; l&#7841;i ph&#7843;n h&#7891;i.</p></div>';
        return;
      }
      state.notes.forEach(note => {
        const item = document.createElement('div');
        item.className = 'note-item';
        const author = note.author || {};
        const lessonTitle = note.lessonTitle || ('B&#224;i h&#7885;c #' + (note.lessonId || ''));
        const courseTitle = note.courseTitle || ('Kh&#243;a #' + (note.courseId || ''));
        const created = note.createdAt ? new Date(note.createdAt).toLocaleString('vi-VN') : '';
        const lastComment = note.lastCommentAt ? new Date(note.lastCommentAt).toLocaleString('vi-VN') : 'Ch&#432;a c&#243; ph&#7843;n h&#7891;i';
        const status = note.status || 'pending';
        const commentsCount = (note.comments && note.comments.length) ? note.comments.length : (note.commentCount || 0);

        item.innerHTML = `
          <div class="note-headline">
            <div class="note-course">
              <p class="course-label">${courseTitle}</p>
              <p class="lesson-label">${lessonTitle}</p>
            </div>
            <span class="badge ${status === 'resolved' ? 'badge-success' : 'badge-warning'}">${statusLabels[status] || status}</span>
          </div>
          <p class="note-content">${note.content || ''}</p>
          <div class="note-stats">
            <div>
              <p class="meta-label">G&#7917;i l&#250;c</p>
              <strong>${created}</strong>
            </div>
            <div>
              <p class="meta-label">Ph&#7843;n h&#7891;i</p>
              <strong>${commentsCount}</strong>
            </div>
            <div>
              <p class="meta-label">C&#7853;p nh&#7853;t</p>
              <strong>${lastComment}</strong>
            </div>
          </div>
          <div class="note-footer">
            <div class="author-chip">
              <div class="avatar">${(author.name || 'H').substring(0,1).toUpperCase()}</div>
              <div>
                <p class="note-author">${author.name || 'H&#7885;c vi&#234;n'}</p>
                <p class="note-subtext">${author.name ? 'Ph&#7843;n h&#7891;i c&#7911;a h&#7885;c vi&#234;n' : 'Ng&#432;&#7901;i g&#7917;i &#7849;n danh'}</p>
              </div>
            </div>
            <button class="btn btn-xs" data-id="${note.id}">Xem chi ti&#7871;t</button>
          </div>
        `;
        item.querySelector('button').onclick = () => openDetail(note);
        list.appendChild(item);
      });
    }

    function renderDetail() {
      const panel = qs('#detailPanel');
      const body = qs('#detailBody');
      if (!state.detail) {
        panel.classList.remove('hidden');
        body.classList.add('detail-body-empty');
        body.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">&#128172;</span>
            <p>Ch&#7885;n m&#7897;t ghi ch&#250; &#7903; danh s&#225;ch b&#234;n tr&#225;i &#273;&#7875; xem n&#7897;i dung v&#224; ph&#7843;n h&#7891;i.</p>
          </div>
        `;
        return;
      }
      panel.classList.remove('hidden');
      const note = state.detail;
      body.classList.remove('detail-body-empty');
      const author = note.author || {};
      const lessonTitle = note.lessonTitle || ('B&#224;i h&#7885;c #' + (note.lessonId || ''));
      const courseTitle = note.courseTitle || ('Kho&#225; #' + (note.courseId || ''));
      const created = note.createdAt ? new Date(note.createdAt).toLocaleString('vi-VN') : '';
      const status = note.status || 'pending';
      body.innerHTML = `
        <div class="flex justify-between items-start gap-3">
          <div>
            <p class="font-semibold">${author.name || 'H&#7885;c vi&#234;n'}</p>
            <p class="text-xs text-stone-500">${courseTitle} &#8226; ${lessonTitle}</p>
            <p class="text-xs text-stone-500">G&#7917;i l&#250;c: ${created}</p>
          </div>
          <span class="badge ${status === 'resolved' ? 'badge-success' : 'badge-warning'}">${statusLabels[status] || status}</span>
        </div>
        <p class="mt-3 text-sm text-stone-800 whitespace-pre-wrap">${note.content || ''}</p>
        <div class="divider"></div>
        <div class="comments" id="commentList"></div>
        <div class="mt-3 space-y-2">
          <textarea id="replyInput" class="input w-full min-h-[90px]" placeholder="Ph&#7843;n h&#7891;i cho h&#7885;c vi&#234;n...">${state.replyText || ''}</textarea>
          <div class="flex justify-between items-center gap-3">
            <div class="flex gap-2">
              <button id="markResolved" class="btn btn-xs border-stone-300">&#272;&#225;nh d&#7845;u &#273;&#227; ph&#7843;n h&#7891;i</button>
              <button id="markPending" class="btn btn-xs border-stone-300">&#272;&#7875; l&#7841;i ch&#432;a x&#7917; l&#253;</button>
            </div>
            <button id="sendReply" class="btn btn-primary btn-xs" ${state.replying ? 'disabled' : ''}>
              ${state.replying ? '&#272;ang g&#7917;i...' : 'G&#7917;i ph&#7843;n h&#7891;i'}
            </button>
          </div>
        </div>
      `;
      const commentHost = qs('#commentList');
      commentHost.innerHTML = '';
      (note.comments || []).forEach(c => {
        const role = (c.author?.role || '').toLowerCase();
        const roleLabel = role === 'teacher' ? 'Gi&#7843;ng vi&#234;n' : role === 'manager' ? 'Qu&#7843;n l&#253;' : 'H&#7885;c vi&#234;n';
        const createdAt = c.createdAt ? new Date(c.createdAt).toLocaleString('vi-VN') : '';
        const div = document.createElement('div');
        div.className = 'comment-item';
        div.innerHTML = `
          <div class="flex items-center gap-2 text-xs text-stone-500">
            <span class="font-semibold text-stone-800">${c.author?.name || 'H&#7879; th&#7889;ng'}</span>
            <span class="badge badge-ghost">${roleLabel}</span>
            <span>${createdAt}</span>
          </div>
          <p class="text-sm text-stone-700 whitespace-pre-wrap mt-1">${c.content || ''}</p>
        `;
        commentHost.appendChild(div);
      });

      qs('#sendReply').onclick = sendReply;
      qs('#markResolved').onclick = () => updateStatus('resolved');
      qs('#markPending').onclick = () => updateStatus('pending');
      qs('#replyInput').oninput = (e) => setState({ replyText: e.target.value });
    }

    async function fetchCourses() {
      try {
        const { data } = await api('/api/teacher/courses?status=published');
        setState({ courses: Array.isArray(data) ? data : [] });
      } catch (err) {
        console.error(err);
        setState({ courses: [] });
      }
    }

    async function fetchNotes() {
      setState({ loading: true });
      const params = new URLSearchParams();
      if (state.filterCourse) params.set('courseId', state.filterCourse);
      if (state.filterStatus) params.set('status', state.filterStatus);
      if (state.search) params.set('q', state.search);
      try {
        const { data } = await api(`/api/teacher/lesson-notes?${params.toString()}`);
        setState({ notes: Array.isArray(data) ? data : [], loading: false });
      } catch (err) {
        console.error(err);
        setState({ notes: [], loading: false });
      }
    }

    function applyFilters() {
      setState({
        filterCourse: qs('#filterCourse').value,
        filterStatus: qs('#filterStatus').value,
        search: qs('#searchInput').value.trim(),
      });
      fetchNotes();
    }

    function openDetail(note) {
      setState({ detail: note, replyText: '' });
      renderDetail();
    }

    async function sendReply() {
      const note = state.detail;
      const content = (qs('#replyInput')?.value || '').trim();
      if (!note || !content) return;
      setState({ replying: true });
      try {
        const { data } = await api(`/api/lesson-notes/${note.id}/comments`, {
          method: 'POST',
          body: JSON.stringify({ content }),
          headers: { 'Content-Type': 'application/json' },
        });
        // API tr&#7843; v&#7873; note m&#7899;i (&#273;&#227; c&#243; comments)
        setState({
          detail: data || note,
          replyText: '',
          replying: false,
          notes: state.notes.map(n => (n.id === (data?.id || note.id) ? (data || note) : n)),
        });
        renderDetail();
      } catch (err) {
        console.error(err);
        alert('Kh&#244;ng th&#7875; g&#7917;i ph&#7843;n h&#7891;i. Vui l&#242;ng th&#7917; l&#7841;i.');
        setState({ replying: false });
      }
    }

    async function updateStatus(next) {
      if (!state.detail) return;
      try {
        const { data } = await api(`/api/lesson-notes/${state.detail.id}/status`, {
          method: 'PATCH',
          body: JSON.stringify({ status: next }),
          headers: { 'Content-Type': 'application/json' },
        });
        setState({
          detail: data || state.detail,
          notes: state.notes.map(n => (n.id === state.detail.id ? (data || { ...n, status: next }) : n)),
        });
        renderDetail();
      } catch (err) {
        console.error(err);
        alert('Kh&#244;ng th&#7875; c&#7853;p nh&#7853;t tr&#7841;ng th&#225;i.');
      }
    }

    function renderSummary() {
      const pending = state.notes.filter(n => (n.status || 'pending') === 'pending').length;
      const resolved = state.notes.filter(n => n.status === 'resolved').length;
      qs('#summaryPending').textContent = pending;
      qs('#summaryResolved').textContent = resolved;
      qs('#summaryTotal').textContent = state.notes.length;
    }

    function render() {
      renderFilters();
      renderNotes();
      renderDetail();
      renderSummary();
    }

    window.addEventListener('DOMContentLoaded', () => {
      mountNav('nav');
      mountAdminMenu('adminMenu', 'teacher-notes');
      mountAdminUser('adminUserCard');
      if (!token()) {
        alert('B&#7841;n c&#7847;n &#273;&#259;ng nh&#7853;p v&#7899;i vai tr&#242; TEACHER/MANAGER');
        window.location.href = '/app/auth/login.html';
        return;
      }
      qs('#btnApply').onclick = applyFilters;
      qs('#btnReset').onclick = () => {
        setState({ filterCourse: '', filterStatus: '', search: '' });
        fetchNotes();
      };
      qs('#btnRefreshList')?.addEventListener('click', fetchNotes);
      fetchCourses().then(fetchNotes);
    });
  </script>
  <style>
    .filters-card {
      background: radial-gradient(circle at top left, rgba(99,102,241,0.25), rgba(15,23,42,0.95));
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: 0 18px 50px rgba(8,8,18,0.55);
    }
    .filters-header {
      display:flex;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      align-items:center;
    }
    .filters-header h2 {
      margin:4px 0 0;
      font-size:1.2rem;
      color:#f8fafc;
    }
    .chips {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip {
      border:1px solid rgba(148,163,184,0.35);
      border-radius:999px;
      padding:4px 12px;
      font-size:.75rem;
      color:#cbd5f5;
      background:rgba(15,23,42,0.65);
    }
    .filters-card select,
    .filters-card input {
      background:rgba(9,13,34,0.8);
      border:1px solid rgba(148,163,184,0.25);
      color:#f8fafc;
      border-radius:12px;
      padding:10px 12px;
    }
    .filters-card select:focus,
    .filters-card input:focus {
      outline:none;
      border-color:rgba(129,140,248,0.8);
      box-shadow:0 0 0 2px rgba(99,102,241,0.2);
    }
    .summary-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:16px;
    }
    .filter-actions .pill-btn {
      border-radius:999px;
      padding:10px 20px;
      font-weight:600;
      font-size:.9rem;
      border:none;
      transition:all .2s ease;
    }
    .filter-actions .pill-btn.primary {
      background:linear-gradient(135deg,#a855f7,#6366f1);
      color:#fff;
      box-shadow:0 10px 20px rgba(99,102,241,0.35);
    }
    .filter-actions .pill-btn.primary:hover {
      transform:translateY(-1px);
    }
    .filter-actions .pill-btn.ghost {
      background:rgba(15,23,42,0.6);
      color:#cbd5f5;
      border:1px solid rgba(148,163,184,0.3);
    }
    .stat-card {
      border-radius:16px;
      padding:16px;
      border:1px solid rgba(148,163,184,0.2);
      background:rgba(15,23,42,0.75);
      display:flex;
      gap:12px;
      align-items:center;
    }
    .stat-icon {
      width:36px;
      height:36px;
      border-radius:12px;
    }
    .stat-icon.primary { background:linear-gradient(135deg,#818cf8,#6366f1); }
    .stat-icon.warning { background:linear-gradient(135deg,#f97316,#fb923c); }
    .stat-icon.success { background:linear-gradient(135deg,#34d399,#10b981); }
    .stat-value {
      font-size:1.4rem;
      font-weight:700;
      color:#f8fafc;
    }
    .note-item {
      border-radius:18px;
      border:1px solid rgba(226,232,240,0.2);
      padding:18px;
      margin-bottom:16px;
      background:rgba(15,23,42,0.65);
      box-shadow:0 12px 30px rgba(15,23,42,0.35);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .note-headline {
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .note-course .course-label { font-weight:600; color:#e0e7ff; }
    .note-course .lesson-label { font-size:.85rem; color:#94a3b8; }
    .note-content { font-size:.95rem; color:#f1f5f9; line-height:1.5; }
    .note-stats {
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      border:1px dashed rgba(148,163,184,0.3);
      border-radius:12px;
      padding:10px 12px;
      color:#cbd5f5;
    }
    .meta-label {
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#94a3b8;
    }
    .note-footer {
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:12px;
      align-items:center;
    }
    .author-chip { display:flex; gap:10px; align-items:center; }
    .author-chip .avatar {
      width:36px; height:36px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      font-weight:600; color:#0f172a; background:#e2e8f0;
    }
    .note-author { font-weight:600; color:#f1f5f9; }
    .note-subtext, .note-meta { font-size:.85rem; color:#94a3b8; }
    .badge { display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid transparent; }
    .badge-warning { background:#fff7ed; color:#c2410c; border-color:#fed7aa; }
    .badge-success { background:#ecfdf3; color:#15803d; border-color:#bbf7d0; }
    .badge-ghost { background:#f8fafc; color:#475569; border-color:#e2e8f0; }
    .comments { display:flex; flex-direction:column; gap:10px; }
    .comment-item { background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:10px; }
    .divider { height:1px; background:#e2e8f0; margin:12px 0; }
    #detailPanel { position:sticky; top:80px; }
    .list-header, .detail-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .empty-card { border-radius:16px; border:1px dashed rgba(148,163,184,0.4); padding:24px; background:rgba(15,23,42,0.4); color:#94a3b8; }
    .detail-body-empty .empty-state { text-align:center; padding:32px 12px; color:#94a3b8; }
    .empty-icon { font-size:2rem; display:block; margin-bottom:8px; }
  </style>
</head>
<body class="admin-body">
  <div class="admin-shell">
    <aside class="admin-sidebar">
      <div class="admin-brand">
        <span class="eyebrow">Kh&#244;ng gian gi&#7843;ng vi&#234;n</span>
        <strong>Ghi ch&#250; b&#224;i h&#7885;c</strong>
        <p class="muted">Xem v&#224; ph&#7843;n h&#7891;i ghi ch&#250; c&#7911;a h&#7885;c vi&#234;n trong c&#225;c kh&#243;a b&#7841;n d&#7841;y.</p>
      </div>
      <div id="adminUserCard" class="admin-user-card"></div>
      <nav id="adminMenu" class="admin-menu"></nav>
      <div class="admin-sidebar-footer">
        <a class="text-link" href="/app/index.html">&#8592; V&#7873; trang t&#7893;ng quan</a>
      </div>
    </aside>

    <div class="admin-main">
      <div id="nav" data-variant="compact"></div>
      <main class="admin-content">
        <div class="admin-page-header">
          <p class="muted">Theo d&#245;i & ph&#7843;n h&#7891;i</p>
          <h1>Ghi ch&#250; b&#224;i h&#7885;c</h1>
        </div>

        <div class="card filters-card">
          <div class="filters-header">
            <div>
              <p class="muted text-xs">B&#7897; l&#7885;c</p>
              <h2>Thu h&#7865;p danh s&#225;ch ghi ch&#250;</h2>
            </div>
            <div class="chips">
              <span class="chip">Kh&#243;a h&#7885;c</span>
              <span class="chip">Tr&#7841;ng th&#225;i</span>
              <span class="chip">T&#7915; kh&#243;a</span>
            </div>
          </div>
          <div class="grid md:grid-cols-4 gap-3 mt-4">
            <div>
              <label class="muted text-xs">Kh&#243;a h&#7885;c</label>
              <select id="filterCourse" class="input mt-1"></select>
            </div>
            <div>
              <label class="muted text-xs">Tr&#7841;ng th&#225;i</label>
              <select id="filterStatus" class="input mt-1">
                <option value="">T&#7845;t c&#7843;</option>
                <option value="pending">Ch&#432;a ph&#7843;n h&#7891;i</option>
                <option value="resolved">&#272;&#227; ph&#7843;n h&#7891;i</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="muted text-xs">T&#7915; kh&#243;a</label>
              <input id="searchInput" class="input mt-1" placeholder="T&#236;m theo n&#7897;i dung, h&#7885;c vi&#234;n, b&#224;i h&#7885;c..."/>
            </div>
          </div>
          <div class="mt-4 flex gap-2 filter-actions">
            <button id="btnApply" class="btn pill-btn primary">L&#7885;c</button>
            <button id="btnReset" class="btn pill-btn ghost">L&#224;m m&#7899;i</button>
          </div>
        </div>

        <div class="grid summary-grid mt-4">
          <div class="stat-card">
            <div class="stat-icon primary"></div>
            <div>
              <p class="muted tiny">T&#7893;ng ghi ch&#250;</p>
              <p class="stat-value" id="summaryTotal">0</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon warning"></div>
            <div>
              <p class="muted tiny">Ch&#432;a ph&#7843;n h&#7891;i</p>
              <p class="stat-value" id="summaryPending">0</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon success"></div>
            <div>
              <p class="muted tiny">&#272;&#227; ph&#7843;n h&#7891;i</p>
              <p class="stat-value" id="summaryResolved">0</p>
            </div>
          </div>
        </div>

        <div class="grid md:grid-cols-[2fr_1fr] gap-4 mt-4">
          <div class="card">
            <div class="list-header">
              <div>
                <p class="muted tiny">Danh s&#225;ch</p>
                <h3>Ghi ch&#250; m&#7899;i nh&#7845;t</h3>
              </div>
              <button id="btnRefreshList" class="btn ghost btn-xs">L&#224;m m&#7899;i</button>
            </div>
            <div id="notesList"></div>
          </div>

          <div class="card" id="detailPanel">
            <div class="detail-header">
              <div>
                <p class="muted tiny">Chi ti&#7871;t</p>
                <h3>Trao &#273;&#7893;i v&#7899;i h&#7885;c vi&#234;n</h3>
              </div>
            </div>
            <div id="detailBody" class="mt-3 text-sm text-stone-700 detail-body-empty">
              <div class="empty-state">
                <span class="empty-icon">&#128172;</span>
                <p>Ch&#7885;n m&#7897;t ghi ch&#250; &#7903; danh s&#225;ch b&#234;n tr&#225;i &#273;&#7875; xem n&#7897;i dung v&#224; ph&#7843;n h&#7891;i.</p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
</body>
</html>
