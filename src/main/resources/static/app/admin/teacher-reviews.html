<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>&#272;&#225;nh gi&#225; kh&#243;a h&#7885;c</title>
  <link rel="stylesheet" href="/app/app.css"/>
  <script type="module">
    import {mountNav, mountAdminMenu, mountAdminUser, api, token} from '/app/app-common.js';

    const state = {
      courses: [],
      reviews: [],
      filterCourse: '',
      filterStatus: 'pending',
      search: '',
      loading: false,
    };

    const statusLabels = {
      pending: '\u0110ang ch\u1EDD duy\u1EC7t',
      approved: '\u0110\u00E3 duy\u1EC7t',
      rejected: 'T\u1EEB ch\u1ED1i',
    };

    const badgeClasses = {
      pending: 'badge-warning',
      approved: 'badge-success',
      rejected: 'badge-ghost',
    };

    const qs = (sel) => document.querySelector(sel);

    const renderStars = (value) => {
      const score = Number(value) || 0;
      const clamped = Math.max(0, Math.min(5, score));
      const rounded = Math.round(clamped * 10) / 10;
      const full = Math.round(clamped);
      const fullStar = '&#9733;';
      const emptyStar = '&#9734;';
      const stars = fullStar.repeat(full) + emptyStar.repeat(5 - full);
      return `<span class="stars-text">${stars}</span><span class="score-number">${rounded.toFixed(1)}/5</span>`;
    };

    function setState(patch) {
      Object.assign(state, patch);
      render();
    }

    function render() {
      renderFilters();
      renderSummary();
      renderReviews();
    }

    function renderFilters() {
      const courseSelect = qs('#filterCourse');
      if (courseSelect) {
        courseSelect.innerHTML = `<option value="">T&#7845;t c&#7843; kh&#243;a h&#7885;c</option>` +
          state.courses.map((c) => `<option value="${c.id}">${c.title || c.slug || ('Kho\u00E1 #' + c.id)}</option>`).join('');
        courseSelect.value = state.filterCourse || '';
      }
      qs('#filterStatus').value = state.filterStatus || '';
      qs('#searchInput').value = state.search || '';
    }

    function renderSummary() {
      const summary = {
        total: state.reviews.length,
        pending: state.reviews.filter((r) => (r.status || '').toLowerCase() === 'pending').length,
        approved: state.reviews.filter((r) => (r.status || '').toLowerCase() === 'approved').length,
        rejected: state.reviews.filter((r) => (r.status || '').toLowerCase() === 'rejected').length,
      };
      qs('#summaryTotal').textContent = summary.total;
      qs('#summaryPending').textContent = summary.pending;
      qs('#summaryApproved').textContent = summary.approved;
      qs('#summaryRejected').textContent = summary.rejected;
    }

    function renderReviews() {
      const host = qs('#reviewList');
      host.innerHTML = '';
      if (state.loading) {
        host.innerHTML = '<div class="empty">&#272;ang t&#7843;i danh s&#225;ch &#273;&#225;nh gi&#225;...</div>';
        return;
      }
      const keyword = state.search.trim().toLowerCase();
      const filtered = state.reviews.filter((review) => {
        if (!keyword) return true;
        const target = [
          review.courseTitle,
          review.studentName,
          review.comment,
          review.highlight,
          review.improvement,
        ].filter(Boolean).join(' ').toLowerCase();
        return target.includes(keyword);
      });
      if (!filtered.length) {
        host.innerHTML = '<div class="empty">Ch&#432;a c&#243; &#273;&#225;nh gi&#225; n&#224;o kh&#7897;p b&#7897; l&#7885;c.</div>';
        return;
      }
      host.innerHTML = filtered
        .map((review) => {
          const status = (review.status || 'pending').toLowerCase();
          const badge = badgeClasses[status] || 'badge-warning';
          return `
            <article class="card review-card">
              <header class="review-header">
                <div>
                  <p class="review-course">${review.courseTitle || 'Kho\u00E1 h\u1ECDc'}</p>
                  <p class="muted tiny">H\u1ECDc vi\u00EAn: ${review.studentName || '\u1EA8n danh'}</p>
                </div>
                <span class="badge ${badge}">${statusLabels[status] || status}</span>
              </header>
              <section class="review-scores">
                <div><span>&#272;i&#x1EC3;m n&#x1ED9;i dung</span><strong>${renderStars(review.courseScore)}</strong></div>
                <div><span>&#272;i&#x1EC3;m gi&#7843;ng vi&#234;n</span><strong>${renderStars(review.instructorScore)}</strong></div>
                <div><span>H&#x1ED7; tr&#7907; &amp; k&#7929; thu&#7853;t</span><strong>${renderStars(review.supportScore)}</strong></div>
                <div><span>Gi&#7899;i thi&#7879;u</span><strong>${review.wouldRecommend ? 'C&#243;' : 'Kh&#244;ng'}</strong></div>
              </section>
              <section class="review-body">
                ${review.comment ? `<p class="review-comment">${review.comment}</p>` : ''}
                <dl>
                  <div>
                    <dt>&#272;i&#x1EC3;m m&#x1EA1;nh</dt>
                    <dd>${review.highlight || '--'}</dd>
                  </div>
                  <div>
                    <dt>C&#7847;n c&#7843;i thi&#7879;n</dt>
                    <dd>${review.improvement || '--'}</dd>
                  </div>
                  <div>
                    <dt>Ghi ch&#250; qu&#7843;n tr&#7883;</dt>
                    <dd>${review.adminNote || '--'}</dd>
                  </div>
                </dl>
              </section>
              <footer class="review-actions">
                <div class="muted tiny">
                  ${new Date(review.createdAt || Date.now()).toLocaleString('vi-VN')}
                </div>
                <div class="review-buttons">
                  <button class="btn btn-xs ghost" data-action="pending" data-id="${review.id}">Ch&#7901; duy&#7879;t</button>
                  <button class="btn btn-xs" data-action="approve" data-id="${review.id}">Duy&#7879;t</button>
                  <button class="btn btn-xs danger" data-action="reject" data-id="${review.id}">T&#7915; ch&#7889;i</button>
                </div>
              </footer>
            </article>
          `;
        })
        .join('');
      host.querySelectorAll('button').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const action = e.currentTarget.getAttribute('data-action');
          if (!id || !action) return;
          handleAction(id, action);
        });
      });
    }

    async function fetchCourses() {
      try {
        const { data } = await api('/api/teacher/courses?status=published');
        setState({ courses: Array.isArray(data) ? data : [] });
      } catch {
        setState({ courses: [] });
      }
    }

    async function fetchReviews() {
      if (!token()) {
        alert('C\u1EA7n \u0111\u0103ng nh\u1EADp v\u1EDBi vai tr\u00F2 TEACHER ho\u1EB7c MANAGER');
        location.href = '/app/auth/login.html';
        return;
      }
      setState({ loading: true });
      const params = new URLSearchParams();
      if (state.filterCourse) params.set('courseId', state.filterCourse);
      if (state.filterStatus) params.set('status', state.filterStatus);
      if (state.search) params.set('q', state.search);
      try {
        const list = await api(`/api/teacher/course-reviews?${params.toString()}`);
        setState({ reviews: Array.isArray(list) ? list : [], loading: false });
      } catch (err) {
        qs('#reviewList').innerHTML = `<div class="empty">Kh&#244;ng t&#7843;i &#273;&#432;&#7907;c &#273;&#225;nh gi&#225;: ${err.message || err}</div>`;
        setState({ reviews: [], loading: false });
      }
    }

    function applyFilters() {
      setState({
        filterCourse: qs('#filterCourse').value,
        filterStatus: qs('#filterStatus').value,
        search: qs('#searchInput').value.trim(),
      });
      fetchReviews();
    }

    async function handleAction(id, action) {
      let next = 'pending';
      if (action === 'approve') next = 'approved';
      else if (action === 'reject') next = 'rejected';
      let adminNote = '';
      if (action === 'reject') {
        adminNote = prompt('L\u00FD do t\u1EEB ch\u1ED1i (c\u00F3 th\u1EC3 \u0111\u1EC3 tr\u1ED1ng):', '') || '';
      }
      try {
        await api(`/api/teacher/course-reviews/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: next, adminNote }),
        });
        fetchReviews();
        alert('\u0110\u00E3 c\u1EADp nh\u1EADt \u0111\u00E1nh gi\u00E1');
      } catch (err) {
        alert(err?.message || 'Kh\u00F4ng c\u1EADp nh\u1EADt \u0111\u01B0\u1EE3c \u0111\u00E1nh gi\u00E1');
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      mountNav('nav');
      mountAdminMenu('adminMenu', 'teacher-reviews');
      mountAdminUser('adminUserCard');
      if (!token()) {
        location.href = '/app/auth/login.html';
        return;
      }
      qs('#btnApply').onclick = applyFilters;
      qs('#btnReset').onclick = () => {
        setState({ filterCourse: '', filterStatus: 'pending', search: '' });
        fetchReviews();
      };
      qs('#btnRefresh').onclick = fetchReviews;
      fetchCourses().then(fetchReviews);
    });
  </script>
  <style>
    .filters-card {
      background: radial-gradient(circle at top left, rgba(99,102,241,0.25), rgba(15,23,42,0.95));
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: 0 20px 50px rgba(10,12,25,0.45);
      border-radius: 24px;
      padding: 20px;
    }
    .filters-card label {
      font-size: .78rem;
      color: #cbd5f5;
    }
    .filters-card select,
    .filters-card input {
      width: 100%;
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(9,14,32,0.8);
      color: #f8fafc;
      padding: 10px 12px;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .stat-card {
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.2);
      padding: 16px;
      background: rgba(15,23,42,0.7);
      color: #f8fafc;
    }
    .stat-card .label {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .2em;
      color: #94a3b8;
    }
    .stat-card .value {
      font-size: 1.7rem;
      font-weight: 700;
      margin-top: 4px;
    }
    .review-card {
      margin-bottom: 16px;
    }
    .review-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .review-course {
      font-size: 1rem;
      font-weight: 600;
      color: #0f172a;
    }
    .review-scores {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
      gap: 12px;
      margin: 16px 0;
      background: #f8fafc;
      border-radius: 12px;
      padding: 12px;
      font-size: .85rem;
      color: #475569;
    }
    .review-body dl {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .review-body dt {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .1em;
      color: #94a3b8;
    }
    .review-body dd {
      margin: 4px 0 0;
      font-size: .9rem;
      color: #334155;
    }
    .review-comment {
      font-size: .95rem;
      color: #0f172a;
      margin-bottom: 8px;
    }
    .review-actions {
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .review-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn.danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .stars-text {
      display: block;
      font-size: 1rem;
      color: #fbbf24;
      letter-spacing: .1em;
    }
    .score-number {
      display: block;
      font-size: .8rem;
      color: #475569;
      margin-top: 2px;
    }
  </style>
</head>
<body class="admin-body">
  <div class="admin-shell">
    <aside class="admin-sidebar">
      <div class="admin-brand">
        <span class="eyebrow">Studio gi&#7843;ng vi&#234;n</span>
        <strong>&#272;&#225;nh gi&#225; kh&#243;a h&#7885;c</strong>
        <p class="muted">Theo d&#245;i v&#224; duy&#7879;t nh&#7853;n x&#233;t t&#7915; h&#7885;c vi&#234;n.</p>
      </div>
      <div id="adminUserCard" class="admin-user-card"></div>
      <nav id="adminMenu" class="admin-menu"></nav>
      <div class="admin-sidebar-footer">
        <a class="text-link" href="/app/index.html">&larr; V&#7873; trang t&#7893;ng quan</a>
      </div>
    </aside>
    <div class="admin-main">
      <div id="nav" data-variant="compact"></div>
      <main class="admin-content">
        <div class="admin-page-header">
          <p class="muted">Theo d&#245;i &amp; x&#7917; l&#253;</p>
          <h1>&#272;&#225;nh gi&#225; kh&#243;a h&#7885;c</h1>
        </div>
        <div class="card filters-card">
          <div class="grid md:grid-cols-4 gap-3">
            <div>
              <label for="filterCourse">Kh&#243;a h&#7885;c</label>
              <select id="filterCourse"></select>
            </div>
            <div>
              <label for="filterStatus">Tr&#7841;ng th&#225;i</label>
              <select id="filterStatus">
                <option value="pending">&#272;ang ch&#7901;</option>
                <option value="approved">&#272;&#227; duy&#7879;t</option>
                <option value="rejected">T&#7915; ch&#7889;i</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label for="searchInput">T&#7915; kh&#243;a</label>
              <input id="searchInput" placeholder="T&#236;m theo h&#7885;c vi&#234;n, ghi ch&#250;, nh&#7853;n x&#233;t..."/>
            </div>
          </div>
          <div class="mt-4 flex gap-2 flex-wrap">
            <button id="btnApply" class="btn btn-primary btn-xs">L&#7885;c</button>
            <button id="btnReset" class="btn btn-xs border-stone-300">L&#224;m m&#7899;i</button>
            <button id="btnRefresh" class="btn ghost btn-xs">T&#7843;i l&#7841;i danh s&#225;ch</button>
          </div>
        </div>
        <div class="summary-grid">
          <div class="stat-card">
            <div class="label">T&#7893;ng</div>
            <div class="value" id="summaryTotal">0</div>
          </div>
          <div class="stat-card">
            <div class="label">&#272;ang ch&#7901;</div>
            <div class="value" id="summaryPending">0</div>
          </div>
          <div class="stat-card">
            <div class="label">&#272;&#227; duy&#7879;t</div>
            <div class="value" id="summaryApproved">0</div>
          </div>
          <div class="stat-card">
            <div class="label">T&#7915; ch&#7889;i</div>
            <div class="value" id="summaryRejected">0</div>
          </div>
        </div>
        <div class="card" id="listCard">
          <h2 class="text-base font-semibold text-stone-800">Danh s&#225;ch &#273;&#225;nh gi&#225;</h2>
          <div id="reviewList" class="mt-4 space-y-4"></div>
        </div>
      </main>
    </div>
  </div>
</body>
</html>
